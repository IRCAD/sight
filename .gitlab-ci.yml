stages:
  - lint
  - prebuild
  - build
  - deploy-test
  - deploy

include:
  - project: "sight/sight-gitlab"
    ref: dev
    file: "/.templates/deploy.yml"
  - project: "sight/sight-gitlab"
    ref: dev
    file: "/.templates/build.yml"

lint:sheldon:
  extends: .lint

.linux_build:
  extends: .linux_before
  dependencies: []
  stage: build
  variables:
    SIGHT_BUILD_DOC: "OFF"
    SIGHT_BUILD_PACKAGES: "OFF"
    SIGHT_BUILD_SDK: "OFF"
  script:
    # Reset the modified time of all files to improve ccache performance
    - /usr/lib/git-core/git-restore-mtime --force --skip-missing --commit-time
    # Print CCache statistics
    - ccache -s
    # Launch CMake
    - cd $CI_PROJECT_DIR/.build
    - >
      cmake $CI_PROJECT_DIR
      -G Ninja
      -DCMAKE_INSTALL_PREFIX=$CI_PROJECT_DIR/.install
      -DCMAKE_BUILD_TYPE=${BUILD_TYPE}
      -DSIGHT_ARCH=sandybridge
      -DSIGHT_BUILD_TESTS=ON
      -DSIGHT_BUILD_DOC=${SIGHT_BUILD_DOC}
      -DSIGHT_ENABLE_PCH=OFF
      -DSIGHT_DEPS_ROOT_DIRECTORY=/cache/.sight-deps
      -DSIGHT_ENABLE_OPENVSLAM=ON
      -DSIGHT_ENABLE_REALSENSE=ON
      -DSIGHT_ENABLE_COVERAGE=${SIGHT_ENABLE_COVERAGE}
      -DSIGHT_ENABLE_GDB=ON
      -DCMAKE_EXPORT_COMPILE_COMMANDS=${SIGHT_ENABLE_CLANG_TIDY}
    # Analyze sources with Clang-Tidy
    - >
      if [ "${SIGHT_ENABLE_CLANG_TIDY}" == "ON" ]; then
        sed -i s/-gmodules//g compile_commands.json
        git diff --name-only --diff-filter=d --merge-base dev | grep '.cpp$' >sources.txt || true
        if [ $(cat sources.txt | wc -l) -gt 0 ]; then
            run-clang-tidy-13 -j$(nproc) -p . $(cat sources.txt) | tee clang-tidy.log
            aha -f clang-tidy.log >clang-tidy.html
            echo [ >tmp.json
            sed -En s+.*$(realpath $PWD/..)/'([^:]*):([^:]*):[^:]*: .*warning:[^ ]* .*\[1m(.*) (\[.*\]).*+{"description": "\3 \4", "fingerprint": "\1:\2\4", "severity": "minor", "location": {"path": "\1", "lines": {"begin": \2}}},+p' clang-tidy.log >>tmp.json
            head -c -2 tmp.json >codequality.json
            echo ] >>codequality.json
        fi
      fi
    # Touch all generated files to improve CCache performance
    - find . -type f -iname '*.?pp' -exec touch -t 197001010000 {} \;
    # Build
    - ninja | tee output.log
    # Generate metrics information
    - nb_warnings=$(grep -c "warning:" output.log)
    - nb_deprecated=$(grep -ce "-Wdeprecated-declarations" output.log)
    - echo -e "Cpp_Warnings $nb_warnings\nCpp_Deprecated_declaration $nb_deprecated" >metrics.txt
    # Print CCache statistics (Cache hit rate should have raised)
    - ccache -s
    # Clone sight-data.
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@git.ircad.fr/Sight/sight-data.git -b ${EXTRA_BRANCH}
    - export FWTEST_DATA_DIR=$CI_PROJECT_DIR/.build/sight-data
    - export IMAGE_OUTPUT_PATH=$CI_PROJECT_DIR/.build/testImages
    - mkdir -p $IMAGE_OUTPUT_PATH
    # Launch tests
    - ctest --timeout 480 --output-on-failure -O ctest.log -j4 --output-junit junit.xml
    # Build documentation if needed
    - >
      if [ "${SIGHT_BUILD_DOC}" == "ON" ]; then
        ninja doc
      fi
    - >
      if [ "${SIGHT_BUILD_PACKAGES}" == "ON" ]; then
        ninja SightViewer_package
        rm -rf ${CI_PROJECT_DIR}/.install

        ninja SightCalibrator_package
        rm -rf ${CI_PROJECT_DIR}/.install
      fi
    - >
      if [ "${SIGHT_BUILD_SDK}" == "ON" ]; then
        ninja install
        ninja package
      fi
    - >
      if [ "${SIGHT_ENABLE_COVERAGE}" == "ON" ]; then
        mkdir -p coverage
        gcovr -j$(nproc) -r .. --filter ../libs --filter ../modules --exclude ".*test.*" --html --html-details coverage/index.html --xml coverage/cobertura-coverage.xml --print-summary . | grep lines | sed -sE 's/.* \((.*) out of (.*)\)/\1\/\2/' | xargs -i echo 'scale=4;a={}*100;scale=2;a/1' | bc | xargs -i echo "lines: {}%"
      fi

  artifacts: &linux_build_artifacts
    when: always
    paths:
      - .build/ctest.log
      - .build/Documentation/Doxygen/
      - .build/packages/*.tar.zst
      - .build/coverage
      - .build/bin/*.core
      - .build/testImages
      - .build/clang-tidy.html
    reports:
      junit: .build/junit.xml
      metrics: .build/metrics.txt
      codequality: .build/codequality.json

.linux_deploy_test:
  extends: .linux_before
  dependencies: []
  stage: deploy-test
  variables:
    SIGHT_TEST_PACKAGES: "OFF"
    SIGHT_TEST_SDK: "OFF"
  script:
    - cd .build
    - >
      if [ "${SIGHT_TEST_PACKAGES}" == "ON" ]; then
        tar -xf packages/SightViewer-*.tar.zst
        echo Testing SightViewer:
        timeout 5s xvfb-run -a SightViewer-*/bin/sightviewer || [ $? -eq 124 ]

        tar -xf packages/SightCalibrator-*.tar.zst
        echo Testing SightCalibrator:
        timeout 5s xvfb-run -a SightCalibrator-*/bin/sightcalibrator || [ $? -eq 124 ]
      fi
    - >
      if [ "${SIGHT_TEST_SDK}" == "ON" ]; then
        tar -xf packages/sight-*.tar.zst
        PACKAGE_NAME=$(cmake -DGET_ARCHIVE_FOLDER=ON -DCMAKE_BUILD_TYPE=${BUILD_TYPE} -P "${CI_PROJECT_DIR}/cmake/build/download_deps.cmake" 2>&1)
        for program in sight-*/bin/{ex*,tuto*,sightviewer,sightcalibrator,dicomxplorer}; do
            echo Testing $(basename $program):
            LD_LIBRARY_PATH=/cache/.sight-deps/$PACKAGE_NAME/lib timeout 5s xvfb-run -a $program || [ $? -eq 124 ]
        done
        for program in sight-*/bin/{arucomarker,dicomanonymizer,networkproxy}; do
            echo Testing $(basename $program):
            $program --help
        done
      fi

build:linux-21.10-debug-gcc:
  extends: .linux_build
  variables:
    BUILD_TYPE: "Debug"
    SIGHT_BUILD_SDK: "ON"
    SIGHT_IGNORE_UNSTABLE_TESTS: 1
    CC: "/usr/lib/ccache/gcc"
    CXX: "/usr/lib/ccache/g++"

build:linux-21.10-release-gcc:
  extends: .linux_build
  variables:
    BUILD_TYPE: "Release"
    SIGHT_BUILD_SDK: "ON"
    SIGHT_BUILD_PACKAGES: "ON"
    SIGHT_IGNORE_UNSTABLE_TESTS: 1
    CC: "/usr/lib/ccache/gcc"
    CXX: "/usr/lib/ccache/g++"

build:linux-21.10-RelWithDebInfo-clang:
  extends: .linux_build
  variables:
    BUILD_TYPE: "RelWithDebInfo"
    SIGHT_IGNORE_UNSTABLE_TESTS: 1
    SIGHT_ENABLE_CLANG_TIDY: "ON"
    CC: "/usr/lib/ccache/clang"
    CXX: "/usr/lib/ccache/clang++"

build:linux-21.10-coverage-gcc:
  extends: .linux_build
  variables:
    BUILD_TYPE: "RelWithDebInfo"
    SIGHT_BUILD_DOC: "ON"
    SIGHT_ENABLE_COVERAGE: "ON"
    SIGHT_IGNORE_UNSTABLE_TESTS: 1
    CC: "/usr/lib/ccache/gcc"
    CXX: "/usr/lib/ccache/g++"

deploy-test:linux-debug:
  extends: .linux_deploy_test
  dependencies:
    - build:linux-21.10-debug-gcc
  variables:
    SIGHT_TEST_SDK: "ON"

deploy:linux-debug:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-debug-gcc
    - deploy-test:linux-debug
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:linux-debug:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-debug-gcc
    - deploy-test:linux-debug
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  when: manual

deploy-test:linux-release:
  extends: .linux_deploy_test
  dependencies:
    - build:linux-21.10-release-gcc
  variables:
    SIGHT_TEST_PACKAGES: "ON"
    SIGHT_TEST_SDK: "ON"

deploy:linux-release:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-release-gcc
    - deploy-test:linux-release
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:linux-release:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-release-gcc
    - deploy-test:linux-release
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  when: manual

deploy:apps-linux-release:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-release-gcc
    - deploy-test:linux-release
  variables:
    APPS: "SightViewer,SightCalibrator"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:apps-linux-release:
  extends: .linux_deploy
  dependencies:
    - build:linux-21.10-release-gcc
    - deploy-test:linux-release
  variables:
    APPS: "SightViewer,SightCalibrator"
    URL: "IRCAD%20-%20Open/"
  when: manual

.windows_build:
  extends: .windows_before
  dependencies: []
  variables:
    TOOLCHAIN: "scripts\\buildsystems\\vcpkg.cmake"
    SIGHT_BUILD_PACKAGES: "OFF"
    SIGHT_BUILD_SDK: "OFF"
  stage: build
  script:
    # Get the package_name name from our CMake script
    - $PACKAGE_NAME = cmd /c cmake -DGET_ARCHIVE_FOLDER=ON -P "${env:CI_PROJECT_DIR}\cmake\build\download_deps.cmake" '2>&1'
    # Build the project on the merge result.
    - cd "${env:CI_PROJECT_DIR}/build"
    - cmake "$env:CI_PROJECT_DIR" -G Ninja -DCMAKE_TOOLCHAIN_FILE="$CACHE\$PACKAGE_NAME\$TOOLCHAIN" -DCMAKE_INSTALL_PREFIX="$env:CI_PROJECT_DIR/install" -DCMAKE_BUILD_TYPE="$BUILD_TYPE" -DSIGHT_BUILD_TESTS=ON -DSIGHT_ENABLE_PCH=ON
    - $env:TMP="$CACHE\tmp"
    - $env:TEMP="$CACHE\tmp"
    - ninja
    # Clone sight-data.
    - git clone --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@git.ircad.fr/Sight/sight-data.git -b ${EXTRA_BRANCH}
    - $env:FWTEST_DATA_DIR="${env:CI_PROJECT_DIR}/build/sight-data"
    - $env:IMAGE_OUTPUT_PATH="${env:CI_PROJECT_DIR}/build/testImages"
    - md "${env:IMAGE_OUTPUT_PATH}"
    # Launch tests
    - ctest --timeout 480 --output-on-failure -O ctest.log -j6 --output-junit junit.xml
    - |
      if ("${SIGHT_BUILD_PACKAGES}" -eq "ON") {
        ninja SightViewer_package
        Remove-Item -Path "${env:CI_PROJECT_DIR}/install" -Force -Recurse

        ninja SightCalibrator_package
        Remove-Item -Path "${env:CI_PROJECT_DIR}/install" -Force -Recurse
      }
    - |
      if ("${SIGHT_BUILD_SDK}" -eq "ON") {
        ninja install
        ninja package
      }
  artifacts:
    when: always
    name: "${env:CI_JOB_NAME}-${env:CI_COMMIT_REF_SLUG}"
    paths:
      - build/ctest.log
      - build/fwTest.log
      - build/packages/*.exe
      - build/packages/sight-*.zip
      - build/testImages
    reports:
      junit: build/junit.xml

.windows_deploy_test:
  dependencies: []
  stage: deploy-test
  variables:
    SIGHT_TEST_PACKAGES: "OFF"
    SIGHT_TEST_SDK: "OFF"
    CACHE: "D:\\gitlab-cache"
  script:
    - $PACKAGE_NAME = cmd /c cmake -DGET_ARCHIVE_FOLDER=ON -P "${env:CI_PROJECT_DIR}\cmake\build\download_deps.cmake" '2>&1'
    - cd build
    - |
      if("${SIGHT_TEST_PACKAGES}" -eq "ON"){
        Start-Process -Wait .\packages\SightViewer-*.exe /S,/D=${pwd}\SightViewer
        $process = Start-Process -PassThru -NoNewWindow SightViewer\bin\sightviewer.bat --no-abort-dialog,--clog
        $process | Wait-Process -Timeout 5 -ErrorAction SilentlyContinue
        ForEach($p in Get-CimInstance Win32_Process | Where-Object {$_.ParentProcessId -eq $process.Id}){
          (Get-Process -Id $p.ProcessId).CloseMainWindow() | out-null
          $process | Wait-Process
        }
        if($process.ExitCode -ne 0){
          Write-Error "SightViewer crashed." -ErrorAction Stop
        }

        Start-Process -Wait .\packages\SightCalibrator-*.exe /S,/D=${pwd}\SightCalibrator
        $process = Start-Process -PassThru -NoNewWindow SightCalibrator\bin\sightcalibrator.bat --no-abort-dialog,--clog
        $process | Wait-Process -Timeout 5 -ErrorAction SilentlyContinue
        ForEach($p in Get-CimInstance Win32_Process | Where-Object {$_.ParentProcessId -eq $process.Id}){
          (Get-Process -Id $p.ProcessId).CloseMainWindow() | out-null
          $process | Wait-Process
        }
        if($process.ExitCode -ne 0){
          Write-Error "SightCalibrator crashed." -ErrorAction Stop
        }
      }
    - |
      if("${SIGHT_TEST_SDK}" -eq "ON"){
        Expand-Archive packages/sight-*.zip
        cd sight-*/*/bin
        $env:PATH += ";$CACHE\$PACKAGE_NAME\installed\x64-windows\bin"
        ForEach($program in Get-ChildItem ex*.bat,tuto*.bat,sightviewer.bat,sightcalibrator.bat,dicomxplorer.bat){
          $programName = Split-Path -Leaf $program
          Write-Host Testing $programName
          $process = Start-Process -PassThru -NoNewWindow $program --no-abort-dialog,--clog
          $process | Wait-Process -Timeout 5 -ErrorAction SilentlyContinue
          ForEach($p in Get-CimInstance Win32_Process | Where-Object {$_.ParentProcessId -eq $process.Id}){
              (Get-Process -Id $p.ProcessId).CloseMainWindow() | out-null
              $process | Wait-Process -Timeout 5
              if(!$process.HasExited){
                (Get-Process -Id $p.ProcessId).Kill()
                $process | Wait-Process
              }
          }
          if(!($process.ExitCode -in -1,0)){
              Write-Error "$programName crashed." -ErrorAction Stop
          }
        }
        ForEach($program in Get-ChildItem arucomarker.exe,dicomanonymizer.exe){
          $programName = Split-Path -Leaf $program
          Write-Host Testing $programName
          Start-Process -NoNewWindow -Wait $program --help
        }
      }
  tags:
    - windows

build:windows-debug:
  extends: .windows_build
  variables:
    BUILD_TYPE: "Debug"
    SIGHT_BUILD_SDK: "ON"

build:windows-release:
  extends: .windows_build
  variables:
    BUILD_TYPE: "Release"
    SIGHT_BUILD_PACKAGES: "ON"
    SIGHT_BUILD_SDK: "ON"

deploy-test:window-debug:
  extends: .windows_deploy_test
  dependencies:
    - build:windows-debug
  variables:
    SIGHT_TEST_SDK: "ON"

deploy:windows-debug:
  extends: .windows_deploy
  dependencies:
    - build:windows-debug
    - deploy-test:window-debug
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:windows-debug:
  extends: .windows_deploy
  dependencies:
    - build:windows-debug
    - deploy-test:window-debug
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  when: manual

deploy-test:windows-release:
  extends: .windows_deploy_test
  dependencies:
    - build:windows-release
  variables:
    SIGHT_TEST_PACKAGES: "ON"
    SIGHT_TEST_SDK: "ON"

deploy:windows-release:
  extends: .windows_deploy
  dependencies:
    - build:windows-release
    - deploy-test:windows-release
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:windows-release:
  extends: .windows_deploy
  dependencies:
    - build:windows-release
    - deploy-test:windows-release
  variables:
    APPS: "sight-"
    URL: "IRCAD%20-%20Open/"
  when: manual

deploy:apps-windows-release:
  extends: .windows_deploy
  dependencies:
    - build:windows-release
    - deploy-test:windows-release
  variables:
    APPS: "SightViewer,SightCalibrator"
    URL: "IRCAD%20-%20Open/"
  only:
    refs:
      - master
      - dev

deploy_manual:apps-windows-release:
  extends: .windows_deploy
  dependencies:
    - build:windows-release
    - deploy-test:windows-release
  variables:
    APPS: "SightViewer,SightCalibrator"
    URL: "IRCAD%20-%20Open/"
  when: manual

deploy:pages:
  image: "${SIGHT_CI_UBUNTU21_10}:dev"
  stage: deploy
  dependencies:
    - build:linux-21.10-coverage-gcc
  script:
    - mv .build/Documentation/Doxygen/html/ public/
    - mv .build/coverage/ public/coverage
  artifacts:
    paths:
      - public
  only:
    - dev
